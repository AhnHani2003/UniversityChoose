<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gợi ý ngành nghề</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .selected { outline: 2px solid #333; }
    .result-card {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      background-color: #f9f9f9;
      width: 50%;
      margin: 30px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .result-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #ddd;
    }
    .result-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gợi ý ngành nghề phù hợp</h1>

    <form id="careerForm">
      <!-- Câu hỏi 1: Tư vấn gia đình -->
      <div class="form-group" style="border:2px solid #000; padding:20px; background-color:#f0f0f0;">
        <label for="family_advice">Bạn có nhận được sự tư vấn của gia đình không?</label>
        <div>
          <!-- giữ setAnswer như bạn yêu cầu -->
          <button type="button" onclick="setAnswer('family_advice', 'Có', this)">Có</button>
          <button type="button" onclick="setAnswer('family_advice', 'Có, nhưng không nhiều', this)">Có, nhưng không nhiều</button>
          <button type="button" onclick="setAnswer('family_advice', 'Không', this)">Không</button>
        </div>
        <input type="hidden" name="family_advice" id="family_advice" value="">
      </div>

      <!-- Câu hỏi 2: Ảnh hưởng tài chính (yes/no) -->
      <div class="form-group" style="border:2px solid #000; padding:20px; background-color:#f0f0f0;">
        <label for="financial_influence">Tài chính có ảnh hưởng đến việc chọn ngành/chọn trường của bạn không?</label>
        <div>
          <button type="button" class="toggle-field-button" data-input="financial_influence" data-value="yes">Có</button>
          <button type="button" class="toggle-field-button" data-input="financial_influence" data-value="no">Không</button>
        </div>
        <input type="hidden" name="financial_influence" id="financial_influence" value="no">
      </div>

      <!-- Câu hỏi 3: Gia đình làm trong lĩnh vực nào? (yes/no) -->
      <div class="form-group" style="border:2px solid #000; padding:20px; background-color:#f0f0f0;">
        <label>Gia đình của bạn có đang làm trong lĩnh vực nào không?</label>
        <div>
          <button type="button" class="toggle-field-button" data-input="family_has_industry" data-value="yes">Có</button>
          <button type="button" class="toggle-field-button" data-input="family_has_industry" data-value="no">Không</button>
        </div>
        <input type="hidden" name="family_has_industry" id="family_has_industry" value="no">
      </div>

      <!-- Lĩnh vực gia đình: hiện khi family_has_industry = yes -->
      <div id="fields-container_3" class="form-group" style="display:none;">
        <label for="family_industry_select">Chọn lĩnh vực</label>
        <select class="form-control" id="family_industry_select" name="family_industry_select">
          {% for field in fields %}
            <option value="{{ field }}">{{ field }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- MBTI -->
      <h3>MBTI</h3>
      <label style="font-size:14px;">Nếu bạn không biết MBTI, hãy thử làm bài kiểm tra trên các website khác</label><br/>
      <select id="mbti" required style="font-size:16px;">
        <option value="" disabled selected>Chọn MBTI</option>
        {% for option in mbti_options %}
          <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
      </select>

      <!-- Tổ hợp môn -->
      <h3 id="subject-combinations-header">Tổ hợp môn</h3>
      <div style="border:2px solid #000; padding:20px; background-color:#f0f0f0;">
        <div class="menu-tree" style="display:flex; flex-wrap:wrap; gap:20px;">
          <!-- A -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn A</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('A') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
          <!-- B -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn B</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('B') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
          <!-- C -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn C</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('C') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
          <!-- D -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn D</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('D') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
          <!-- N -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn N</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('N') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
          <!-- S -->
          <div class="label-item multiple custom-cursor-on-hover" style="flex:1; min-width:200px;">
            <label style="font-weight:bold; color:#0e1212; border:3px solid #000; padding:10px;">Tổ hợp môn S</label>
            <ul class="submenu" style="display:none; border:5px solid #000; padding:10px; background-color:#e0f7fa;">
              {% for option in subject_combination_options if option.startswith('S') %}
                <label><input type="checkbox" name="subjects" value="{{ option }}"> {{ option }}</label>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Preview các tổ hợp đã chọn -->
      <div style="font-size:18px; margin-top:10px;">
        Tổ hợp môn đã chọn:
        <div id="selected-subjects"></div>
      </div>

      <!-- Khả năng và Điểm mạnh -->
      <h3>Khả năng và Điểm mạnh</h3>
      <div class="checkbox-group" id="strengthsOptions">
        {% for option in strengths_options %}
          <label><input type="checkbox" name="strengths" value="{{ option }}"> {{ option }}</label>
        {% endfor %}
      </div>

      <!-- Sở thích và Đam mê -->
      <h3>Sở thích và Đam mê</h3>
      <div class="checkbox-group" id="interestsOptions">
        {% for option in interests_options %}
          <label><input type="checkbox" name="interests" value="{{ option }}"> {{ option }}</label>
        {% endfor %}
      </div>

      <!-- Nút duy nhất -->
      <div style="margin-top:16px;">
        <button type="button" id="save">Lưu & Gợi ý</button>
        <div id="saveMsg" style="margin-top:8px;"></div>
      </div>
    </form>
  </div>

  <!-- Khung hiển thị kết quả -->
  <div id="results"></div>

  <!-- Inline JS nhỏ cho menu hover + preview tổ hợp -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Hover show/hide submenu
      document.querySelectorAll('.label-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
          const submenu = item.querySelector('.submenu');
          if (submenu) submenu.style.display = 'block';
        });
        item.addEventListener('mouseleave', () => {
          const submenu = item.querySelector('.submenu');
          if (submenu) submenu.style.display = 'none';
        });
      });

      // Preview: tổ hợp môn đã chọn
      document.querySelectorAll('input[name="subjects"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const selected = Array.from(document.querySelectorAll('input[name="subjects"]:checked')).map(i => i.value);
          document.getElementById('selected-subjects').textContent = selected.join(', ');
        });
      });
    });
  </script>

  <!-- Script chính: chỉ 1 nút save -> update DB + render kết quả -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // ===== Helpers =====
    window.setAnswer = function (inputId, value, button) {
      const inputElement = document.getElementById(inputId);
      if (!inputElement) return console.error('Không tìm thấy', inputId);
      inputElement.value = value;
      if (button && button.parentElement) {
        const buttons = button.parentElement.querySelectorAll('button');
        buttons.forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
      }
    };

    function toggleFields(option, inputId, button) {
      const fieldsContainer = document.getElementById('fields-container_3');
      const inputElement = document.getElementById(inputId);
      if (!inputElement) return console.error('Không tìm thấy input ẩn', inputId);

      if (button && button.parentElement) {
        const buttons = button.parentElement.querySelectorAll('button');
        buttons.forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
      }

      if (option === 'yes') {
        if (fieldsContainer && inputId === 'family_has_industry') fieldsContainer.style.display = 'block';
        inputElement.value = 'yes';
      } else {
        if (fieldsContainer && inputId === 'family_has_industry') fieldsContainer.style.display = 'none';
        inputElement.value = 'no';
      }
    }

    // Bind cho các nút toggle yes/no
    const toggleFieldButtons = document.querySelectorAll('.toggle-field-button');
    toggleFieldButtons.forEach(button => {
      button.addEventListener('click', function () {
        const inputId = button.dataset.input; // financial_influence | family_has_industry
        const value   = button.dataset.value; // yes | no
        toggleFields(value, inputId, button);
      });
    });

    // ===== Collectors =====
    function getSelectedMBTI() {
      return document.getElementById('mbti')?.value || '';
    }
    function getSelectedSubjects() {
      return Array.from(document.querySelectorAll('input[name="subjects"]:checked')).map(i => i.value);
    }
    function getSelectedStrengths() {
      return Array.from(document.querySelectorAll('input[name="strengths"]:checked')).map(i => i.value);
    }
    function getSelectedInterests() {
      return Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(i => i.value);
    }
    function getMainStrengths() {
      return Array.from(document.querySelectorAll('input[name="mainstrengths"]:checked')).map(i => i.value);
    }
    function getMainInterests() {
      return Array.from(document.querySelectorAll('input[name="maininterests"]:checked')).map(i => i.value);
    }
    function getFinancialInfluence() {
      return document.getElementById('financial_influence')?.value || 'no';
    }
    function getFamilyHasIndustry() {
      return document.getElementById('family_has_industry')?.value || 'no';
    }
    function getFamilyIndustrySelect() {
      return document.getElementById('family_industry_select')?.value || '';
    }
    function getFamilyAdviceDetail() {
      return document.getElementById('family_advice')?.value || '';
    }

    // ===== Validate để bật/tắt nút save =====
    function validateForm() {
      const mbtiSelected     = (document.getElementById('mbti')?.value || '') !== '';
      const subjectsChecked  = Array.from(document.querySelectorAll('input[name="subjects"]')).some(i => i.checked);
      const strengthsChecked = Array.from(document.querySelectorAll('input[name="strengths"]')).some(i => i.checked);
      const interestsChecked = Array.from(document.querySelectorAll('input[name="interests"]')).some(i => i.checked);
      const saveBtn          = document.getElementById('save');
      if (!saveBtn) return;
      saveBtn.disabled = !(mbtiSelected && subjectsChecked && strengthsChecked && interestsChecked);
    }

    document.getElementById('mbti')?.addEventListener('change', validateForm);
    document.querySelectorAll('input[name="subjects"]').forEach(el => el.addEventListener('change', validateForm));
    document.querySelectorAll('input[name="strengths"]').forEach(el => el.addEventListener('change', validateForm));
    document.querySelectorAll('input[name="interests"]').forEach(el => el.addEventListener('change', validateForm));
    validateForm();

    // ===== Hiển thị kết quả =====
    function displayResults(data) {
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';

      const title = document.createElement('h3');
      title.textContent = 'Kết quả';
      title.style.textAlign = 'center';
      resultsContainer.appendChild(title);

      const card = document.createElement('div');
      card.className = 'result-card';

      (data || []).forEach(item => {
        const row = document.createElement('div');
        row.className = 'result-row';

        const careerCell = document.createElement('div');
        careerCell.style.flex = '3';
        careerCell.style.textAlign = 'left';
        careerCell.style.paddingRight = '10px';
        careerCell.textContent = item.career;

        const scoreCell = document.createElement('div');
        scoreCell.style.flex = '2';
        scoreCell.style.textAlign = 'center';
        scoreCell.textContent = item.score;

        row.appendChild(careerCell);
        row.appendChild(scoreCell);
        card.appendChild(row);
      });

      resultsContainer.appendChild(card);
    }

    // ===== Nút duy nhất: Lưu & Gợi ý =====
    const saveBtn = document.getElementById('save');
    const msgBox  = document.getElementById('saveMsg');

    async function saveAndRecommend() {
      const payload = {
        mbti: getSelectedMBTI(),
        subjects: getSelectedSubjects(),
        strengths: getSelectedStrengths(),
        interests: getSelectedInterests(),
        mainstrengths: getMainStrengths(),   // nếu không có, backend sẽ bỏ qua
        maininterests: getMainInterests(),   // nếu không có, backend sẽ bỏ qua
        financial_influence: getFinancialInfluence(), // "yes" | "no"
        family_has_industry: getFamilyHasIndustry(),  // "yes" | "no"
        family_industry_select: getFamilyIndustrySelect(),
        family_advice: getFamilyAdviceDetail()
        // KHÔNG gửi save_only -> backend sẽ vừa update DB vừa trả Top 10
      };

      try {
        saveBtn.disabled = true;
        if (msgBox) msgBox.textContent = 'Đang xử lý...';

        const res = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        let data = null;
        try { data = await res.json(); } catch(_) {}

        if (!res.ok) {
          if (msgBox) msgBox.textContent = '❌ Lỗi máy chủ' + (data?.error ? ': ' + data.error : '');
          return;
        }

        // /save (không save_only) trả về mảng kết quả top 10
        if (Array.isArray(data)) {
          if (msgBox) msgBox.textContent = '✅ Đã lưu hồ sơ & tạo gợi ý.';
          displayResults(data);
        } else if (data && data.ok) {
          // Phòng trường hợp bạn tạm bật save_only
          if (msgBox) msgBox.textContent = '✅ ' + (data.message || 'Đã lưu hồ sơ.');
        } else {
          if (msgBox) msgBox.textContent = '❌ Không nhận được dữ liệu hợp lệ.';
          console.warn('Phản hồi không như kỳ vọng:', data);
        }
      } catch (e) {
        console.error(e);
        if (msgBox) msgBox.textContent = '❌ Lỗi mạng khi lưu & gợi ý.';
      } finally {
        saveBtn.disabled = false;
        setTimeout(() => { if (msgBox) msgBox.textContent = ''; }, 3000);
      }
    }

    if (saveBtn) saveBtn.addEventListener('click', saveAndRecommend);
  });
  </script>
</body>
</html>
